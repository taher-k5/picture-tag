{% import "_includes/forms" as forms %}

{# Set the page title #}
{% set title = plugin.name ~ ' Settings' | t('app') %}

{# Define the tabs #}
{% set tabs = {
    breakpoints: { label: "Breakpoints"|t('picture-tag'), url: '#breakpoints' },
    transforms: { label: "Transforms"|t('picture-tag'), url: '#transforms' },
    formats: { label: "Formats"|t('picture-tag'), url: '#formats' },
    performance: { label: "Performance"|t('picture-tag'), url: '#performance' },
    accessibility: { label: "Accessibility"|t('picture-tag'), url: '#accessibility' },
    advanced: { label: "Advanced"|t('picture-tag'), url: '#advanced' }
} %}

{# Determine the active tab #}
{% set selectedTab = craft.app.request.getQueryParam('tab') | default('breakpoints') %}

<form method="post" accept-charset="UTF-8" data-saveshortcut="true" data-confirm-unload="true">
    {{ csrfInput() }}
    <input type="hidden" name="action" value="plugins/save-plugin-settings">
    <input type="hidden" name="pluginHandle" value="{{ plugin.handle }}">

    <div class="tabs-wrapper" data-tabs>
        <nav class="tab-nav">
            {% for id, tab in tabs %}
                <a class="tab {% if id == selectedTab %}active{% endif %}" href="{{ url('settings/plugins/picture-tag') }}?tab={{ id }}" data-tab="{{ id }}">{{ tab.label }}</a>
            {% endfor %}
        </nav>

        <div class="tab-content-wrapper">
            {# Breakpoints Tab #}
            <div id="breakpoints" class="tab-content {% if selectedTab != 'breakpoints' %}hidden{% endif %}" data-tab-content="breakpoints">
                <h2>{{ 'Breakpoints' | t('picture-tag') }}</h2>
                {% for key, value in settings.defaultBreakpoints %}
                    {{ forms.textField({
                        label: key | capitalize,
                        name: 'defaultBreakpoints[' ~ key ~ ']',
                        value: value,
                        errors: settings.getErrors('defaultBreakpoints.' ~ key) ?? [],
                        required: true
                    }) }}
                {% endfor %}
            </div>

            {# Transforms Tab #}
            <div id="transforms" class="tab-content {% if selectedTab != 'transforms' %}hidden{% endif %}" data-tab-content="transforms">
                <h2>{{ 'Transforms' | t('picture-tag') }}</h2>
                {{ forms.lightswitchField({
                    label: 'Enable Default Transforms' | t('picture-tag'),
                    name: 'enableDefaultTransforms',
                    on: settings.enableDefaultTransforms,
                    instructions: 'When enabled, default transform values are used unless overridden by user-defined transforms. When disabled, only user-defined transforms are applied.' | t('picture-tag')
                }) }}
                {% for key, transform in {
                    'mobile': {'width': 480, 'height': 320, 'quality': 80},
                    'tablet': {'width': 768, 'height': 512, 'quality': 85},
                    'desktop': {'width': 1024, 'height': 683, 'quality': 90},
                    'large': {'width': 1440, 'height': 960, 'quality': 95}
                } %}
                    <h3>{{ key | capitalize }}</h3>
                    {{ forms.textField({
                        label: 'Width' | t('picture-tag'),
                        name: 'defaultTransforms[' ~ key ~ '][width]',
                        value: settings.defaultTransforms[key]['width'] ?? transform.width,
                        errors: settings.getErrors('defaultTransforms.' ~ key ~ '.width') ?? [],
                        required: true,
                        disabled: not settings.enableDefaultTransforms
                    }) }}
                    {{ forms.textField({
                        label: 'Height' | t('picture-tag'),
                        name: 'defaultTransforms[' ~ key ~ '][height]',
                        value: settings.defaultTransforms[key]['height'] ?? transform.height,
                        errors: settings.getErrors('defaultTransforms.' ~ key ~ '.height') ?? [],
                        required: true,
                        disabled: not settings.enableDefaultTransforms
                    }) }}
                    {{ forms.textField({
                        label: 'Quality' | t('picture-tag'),
                        name: 'defaultTransforms[' ~ key ~ '][quality]',
                        value: settings.defaultTransforms[key]['quality'] ?? transform.quality,
                        errors: settings.getErrors('defaultTransforms.' ~ key ~ '.quality') ?? [],
                        required: true,
                        disabled: not settings.enableDefaultTransforms
                    }) }}
                {% endfor %}
            </div>

            {# Formats Tab #}
            <div id="formats" class="tab-content {% if selectedTab != 'formats' %}hidden{% endif %}" data-tab-content="formats">
                <h2>{{ 'Formats' | t('picture-tag') }}</h2>
                {{ forms.checkboxField({
                    label: 'Enable WebP' | t('picture-tag'),
                    name: 'enableWebP',
                    checked: settings.enableWebP ?? false
                }) }}
                {{ forms.textField({
                    label: 'WebP Quality' | t('picture-tag'),
                    name: 'webpQuality',
                    value: settings.webpQuality ?? '',
                    errors: settings.getErrors('webpQuality') ?? [],
                    size: 5
                }) }}
                {{ forms.checkboxField({
                    label: 'Enable AVIF' | t('picture-tag'),
                    name: 'enableAvif',
                    checked: settings.enableAvif ?? false
                }) }}
                {{ forms.textField({
                    label: 'AVIF Quality' | t('picture-tag'),
                    name: 'avifQuality',
                    value: settings.avifQuality ?? '',
                    errors: settings.getErrors('avifQuality') ?? [],
                    size: 5
                }) }}
                <h2>{{ 'SVG Handling' | t('picture-tag') }}</h2>
                {{ forms.checkboxField({
                    label: 'Enable SVG Optimization' | t('picture-tag'),
                    name: 'enableSvgOptimization',
                    checked: settings.enableSvgOptimization ?? false
                }) }}
                {{ forms.checkboxField({
                    label: 'Inline SVG' | t('picture-tag'),
                    name: 'inlineSvg',
                    checked: settings.inlineSvg ?? false
                }) }}
                {{ forms.textField({
                    label: 'SVG Max Size (bytes)' | t('picture-tag'),
                    name: 'svgMaxSize',
                    value: settings.svgMaxSize ?? '',
                    errors: settings.getErrors('svgMaxSize') ?? [],
                    size: 5
                }) }}
            </div>

            {# Performance Tab #}
            <div id="performance" class="tab-content {% if selectedTab != 'performance' %}hidden{% endif %}" data-tab-content="performance">
                <h2>{{ 'Performance' | t('picture-tag') }}</h2>
                {{ forms.checkboxField({
                    label: 'Enable Lazy Loading' | t('picture-tag'),
                    name: 'enableLazyLoading',
                    checked: settings.enableLazyLoading ?? false
                }) }}
                {{ forms.textField({
                    label: 'Lazy Loading Class' | t('picture-tag'),
                    name: 'lazyLoadingClass',
                    value: settings.lazyLoadingClass ?? ''
                }) }}
                {{ forms.textareaField({
                    label: 'Lazy Placeholder' | t('picture-tag'),
                    name: 'lazyPlaceholder',
                    value: settings.lazyPlaceholder ?? ''
                }) }}
                {{ forms.checkboxField({
                    label: 'Enable Preload' | t('picture-tag'),
                    name: 'enablePreload',
                    checked: settings.enablePreload ?? false
                }) }}
                {{ forms.checkboxField({
                    label: 'Enable Sizes' | t('picture-tag'),
                    name: 'enableSizes',
                    checked: settings.enableSizes ?? false
                }) }}
                {{ forms.checkboxField({
                    label: 'Enable Srcset' | t('picture-tag'),
                    name: 'enableSrcset',
                    checked: settings.enableSrcset ?? false
                }) }}
                {{ forms.checkboxField({
                    label: 'Enable Fetch Priority' | t('picture-tag'),
                    name: 'enableFetchPriority',
                    checked: settings.enableFetchPriority ?? false
                }) }}
            </div>

            {# Accessibility Tab #}
            <div id="accessibility" class="tab-content {% if selectedTab != 'accessibility' %}hidden{% endif %}" data-tab-content="accessibility">
                <h2>{{ 'Accessibility' | t('picture-tag') }}</h2>
                {{ forms.checkboxField({
                    label: 'Require Alt Text' | t('picture-tag'),
                    name: 'requireAltText',
                    checked: settings.requireAltText ?? false
                }) }}
                {{ forms.textField({
                    label: 'Default Alt Text' | t('picture-tag'),
                    name: 'defaultAltText',
                    value: settings.defaultAltText ?? ''
                }) }}
                {{ forms.checkboxField({
                    label: 'Include Default Styles' | t('picture-tag'),
                    name: 'includeDefaultStyles',
                    checked: settings.includeDefaultStyles ?? false
                }) }}
                {{ forms.textField({
                    label: 'Default Picture Class' | t('picture-tag'),
                    name: 'defaultPictureClass',
                    value: settings.defaultPictureClass ?? ''
                }) }}
                {{ forms.textField({
                    label: 'Default Image Class' | t('picture-tag'),
                    name: 'defaultImageClass',
                    value: settings.defaultImageClass ?? ''
                }) }}
            </div>

            {# Advanced Tab #}
            <div id="advanced" class="tab-content {% if selectedTab != 'advanced' %}hidden{% endif %}" data-tab-content="advanced">
                <h2>{{ 'Advanced' | t('picture-tag') }}</h2>
                {{ forms.checkboxField({
                    label: 'Enable Art Direction' | t('picture-tag'),
                    name: 'enableArtDirection',
                    checked: settings.enableArtDirection ?? false
                }) }}
                {{ forms.checkboxField({
                    label: 'Enable Cropping' | t('picture-tag'),
                    name: 'enableCropping',
                    checked: settings.enableCropping ?? false
                }) }}
                {{ forms.checkboxField({
                    label: 'Enable Focal Point' | t('picture-tag'),
                    name: 'enableFocalPoint',
                    checked: settings.enableFocalPoint ?? false
                }) }}
                {{ forms.checkboxField({
                    label: 'Enable Aspect Ratio' | t('picture-tag'),
                    name: 'enableAspectRatio',
                    checked: settings.enableAspectRatio ?? false
                }) }}
                {{ forms.checkboxField({
                    label: 'Enable Cache' | t('picture-tag'),
                    name: 'enableCache',
                    checked: settings.enableCache ?? false
                }) }}
                {{ forms.textField({
                    label: 'Cache Duration (seconds)' | t('picture-tag'),
                    name: 'cacheDuration',
                    value: settings.cacheDuration ?? '',
                    errors: settings.getErrors('cacheDuration') ?? [],
                    size: 5
                }) }}
                {{ forms.checkboxField({
                    label: 'Enable Debug' | t('picture-tag'),
                    name: 'enableDebug',
                    checked: settings.enableDebug ?? false
                }) }}
                {{ forms.checkboxField({
                    label: 'Show Transform Info' | t('picture-tag'),
                    name: 'showTransformInfo',
                    checked: settings.showTransformInfo ?? false
                }) }}
            </div>
        </div>
    </div>
</form>

{# Register Craft 5.x native tab JS with data-tabs initialization
{% if craft.app.request.isCpRequest %}
    {% do craft.app.view.registerJs("Craft.initTabs();") %}
{% endif %} #}