{% extends '_layouts/cp' %}
{% import "_includes/forms" as forms %}

{# Set the page title #}
{% set title = 'Picture Tag' %}

{% set tabs = {
    general: { label: 'General Settings'|t('blitz'), url: '#general' },
    breakpoints: { label: "Breakpoints"|t('picture-tag'), url: '#breakpoints' },
    transforms: { label: "Transforms"|t('picture-tag'), url: '#transforms' },
    performance: { label: "Performance"|t('picture-tag'), url: '#performance' },
} %}

{# Determine the active tab #}
{% set selectedTab = craft.app.request.getQueryParam('tab') | default('general') %}

{% block actionButton %}
    {% if not readOnly %}
        <input type="submit" class="btn submit" placeholder="{{ 'Save'|t('app') }}">
    {% endif %}
{% endblock %}

{% block content %}
    <form method="post" accept-charset="UTF-8" data-saveshortcut="true" data-confirm-unload="true">
        {{ csrfInput() }}

        {% if not readOnly %}
            <input type="hidden" name="action" placeholder="plugins/save-plugin-settings">
            <input type="hidden" name="pluginHandle" placeholder="picture-tag">
        {% endif %}

        <div class="tabs-wrapper" data-tabs>
            <div class="tab-content-wrapper">

                {# General Tab #}
                <div id="general" class="tab-content {% if selectedTab != 'general' %}hidden{% endif %}" data-tab-content="general">
                    {{ forms.lightswitchField({
                        label: 'Enable WebP' | t('picture-tag'),
                        name: 'enableWebP',
                        on: settings.enableWebP ?? false
                    }) }}
                    {{ forms.textField({
                        label: 'WebP Quality' | t('picture-tag'),
                        name: 'webpQuality',
                        placeholder: settings.webpQuality ?? 80,
                        errors: settings.getErrors('webpQuality') ?? [],
                        size: 5,
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable AVIF' | t('picture-tag'),
                        name: 'enableAvif',
                        on: settings.enableAvif ?? false
                    }) }}
                    {{ forms.textField({
                        label: 'AVIF Quality' | t('picture-tag'),
                        name: 'avifQuality',
                        placeholder: settings.avifQuality ?? 75,
                        errors: settings.getErrors('avifQuality') ?? [],
                        size: 5,
                    }) }}
                    <h2>{{ 'SVG Handling' | t('picture-tag') }}</h2>
                    {{ forms.lightswitchField({
                        label: 'Enable SVG Optimization' | t('picture-tag'),
                        name: 'enableSvgOptimization',
                        on: settings.enableSvgOptimization ?? false
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Inline SVG' | t('picture-tag'),
                        name: 'inlineSvg',
                        on: settings.inlineSvg ?? false
                    }) }}
                    {{ forms.textField({
                        label: 'SVG Max Size (bytes)' | t('picture-tag'),
                        name: 'svgMaxSize',
                        placeholder: settings.svgMaxSize ?? 10000,
                        errors: settings.getErrors('svgMaxSize') ?? [],
                        size: 5,
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Require Alt Text' | t('picture-tag'),
                        name: 'requireAltText',
                        on: settings.requireAltText ?? true
                    }) }}
                    {{ forms.textField({
                        label: 'Default Alt Text' | t('picture-tag'),
                        name: 'defaultAltText',
                        placeholder: settings.defaultAltText ?? 'Image',
                        errors: settings.getErrors('defaultAltText') ?? []
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Cache' | t('picture-tag'),
                        name: 'enableCache',
                        on: settings.enableCache ?? false
                    }) }}
                    {{ forms.textField({
                        label: 'Cache Duration (seconds)' | t('picture-tag'),
                        name: 'cacheDuration',
                        placeholder: settings.cacheDuration ?? 3600,
                        errors: settings.getErrors('cacheDuration') ?? [],
                        size: 5,
                        instructions: 'Duration in seconds' | t('picture-tag')
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Debug' | t('picture-tag'),
                        name: 'enableDebug',
                        on: settings.enableDebug ?? false
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Show Transform Info' | t('picture-tag'),
                        name: 'showTransformInfo',
                        on: settings.showTransformInfo ?? false
                    }) }}
                </div>

                {# Breakpoints Tab #}
                <div id="breakpoints" class="tab-content {% if selectedTab != 'breakpoints' %}hidden{% endif %}" data-tab-content="breakpoints">
                    {% for key, placeholder in settings.defaultBreakpoints ?? {'small': 480, 'medium': 768, 'large': 1024} %}
                        {{ forms.textField({
                            label: key | capitalize | t('picture-tag'),
                            name: 'defaultBreakpoints[' ~ key ~ ']',
                            placeholder: placeholder,
                            errors: settings.getErrors('defaultBreakpoints.' ~ key) ?? [],
                            required: true,
                            instructions: 'Pixel width for breakpoint' | t('picture-tag')
                        }) }}
                    {% endfor %}
                </div>

                {# Transforms Tab #}
                <div id="transforms" class="tab-content {% if selectedTab != 'transforms' %}hidden{% endif %}" data-tab-content="transforms">
                    {{ forms.lightswitchField({
                        label: 'Enable Default Transforms' | t('picture-tag'),
                        name: 'enableDefaultTransforms',
                        on: settings.enableDefaultTransforms ?? false
                    }) }}
                    {% for key, transform in {
                        'mobile': {'width': 480, 'height': 320, 'quality': 80},
                        'tablet': {'width': 768, 'height': 512, 'quality': 85},
                        'desktop': {'width': 1024, 'height': 683, 'quality': 90},
                        'large': {'width': 1440, 'height': 960, 'quality': 95}
                    } %}
                        <h3>{{ key | capitalize | t('picture-tag') }}</h3>
                        <div class="flex items-center gap-xl">
                            {{ forms.textField({
                                label: 'Width' | t('picture-tag'),
                                name: 'defaultTransforms[' ~ key ~ '][width]',
                                placeholder: settings.defaultTransforms[key]['width'] ?? transform.width,
                                errors: settings.getErrors('defaultTransforms.' ~ key ~ '.width') ?? [],
                                required: true,
                                disabled: not settings.enableDefaultTransforms,
                                instructions: 'In pixels' | t('picture-tag')
                            }) }}
                            {{ forms.textField({
                                label: 'Height' | t('picture-tag'),
                                name: 'defaultTransforms[' ~ key ~ '][height]',
                                placeholder: settings.defaultTransforms[key]['height'] ?? transform.height,
                                errors: settings.getErrors('defaultTransforms.' ~ key ~ '.height') ?? [],
                                required: true,
                                disabled: not settings.enableDefaultTransforms,
                                instructions: 'In pixels' | t('picture-tag')
                            }) }}
                            {{ forms.textField({
                                label: 'Quality' | t('picture-tag'),
                                name: 'defaultTransforms[' ~ key ~ '][quality]',
                                placeholder: settings.defaultTransforms[key]['quality'] ?? transform.quality,
                                errors: settings.getErrors('defaultTransforms.' ~ key ~ '.quality') ?? [],
                                required: true,
                                disabled: not settings.enableDefaultTransforms,
                                instructions: '0-100' | t('picture-tag')
                            }) }}
                        </div>
                    {% endfor %}
                </div>

                {# Performance Tab #}
                <div id="performance" class="tab-content {% if selectedTab != 'performance' %}hidden{% endif %}" data-tab-content="performance">
                    {{ forms.lightswitchField({
                        label: 'Enable Lazy Loading' | t('picture-tag'),
                        name: 'enableLazyLoading',
                        on: settings.enableLazyLoading ?? false
                    }) }}
                    {{ forms.textField({
                        label: 'Lazy Loading Class' | t('picture-tag'),
                        name: 'lazyLoadingClass',
                        placeholder: settings.lazyLoadingClass ?? 'lazy',
                        errors: settings.getErrors('lazyLoadingClass') ?? []
                    }) }}
                    {{ forms.textareaField({
                        label: 'Lazy Placeholder' | t('picture-tag'),
                        name: 'lazyPlaceholder',
                        placeholder: settings.lazyPlaceholder ?? 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==',
                        rows: 4
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Preload' | t('picture-tag'),
                        name: 'enablePreload',
                        on: settings.enablePreload ?? false
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Sizes' | t('picture-tag'),
                        name: 'enableSizes',
                        on: settings.enableSizes ?? false
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Srcset' | t('picture-tag'),
                        name: 'enableSrcset',
                        on: settings.enableSrcset ?? false
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Fetch Priority' | t('picture-tag'),
                        name: 'enableFetchPriority',
                        on: settings.enableFetchPriority ?? false
                    }) }}
                </div>
            </div>
        </div>
    </form>
{% endblock %}