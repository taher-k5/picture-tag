{% extends '_layouts/cp' %}
{% import "_includes/forms" as forms %}

{# Set the page title #}
{% set title = 'Picture Tag' %}

{% set tabs = {
    'general': { label: 'General Settings'|t('picture-tag'), url: '#general' },
    'breakpoints': { label: "Breakpoints"|t('picture-tag'), url: '#breakpoints' },
    'transforms': { label: "Transforms"|t('picture-tag'), url: '#transforms' },
    'performance': { label: "Performance"|t('picture-tag'), url: '#performance' },
} %}

{# Determine the active tab #}
{% set selectedTab = craft.app.request.getQueryParam('tab') | default('general') %}

{% block actionButton %}
    {% if not readOnly %}
        <input type="submit" class="btn submit" value="{{ 'Save'|t('app') }}">
    {% endif %}
{% endblock %}

{% block content %}
    <form method="post" accept-charset="UTF-8" data-saveshortcut="true" data-confirm-unload="true">
        {{ csrfInput() }}

        {% if not readOnly %}
            <input type="hidden" name="action" value="picture-tag/settings/save">
            <input type="hidden" name="pluginHandle" value="picture-tag">
        {% endif %}

        <div class="tabs-wrapper" data-tabs>
            <div class="tab-content-wrapper">

                {# General Tab #}
                <div id="general" class="tab-content {% if selectedTab != 'general' %}hidden{% endif %}" data-tab-content="general">
                    {{ forms.lightswitchField({
                        label: 'Enable WebP' | t('picture-tag'),
                        name: 'settings[enableWebP]',
                        on: settings.enableWebP ?? false
                    }) }}
                    {{ forms.textField({
                        label: 'WebP Quality' | t('picture-tag'),
                        name: 'settings[webpQuality]',
                        placeholder: settings.PLACEHOLDER_WEBP_QUALITY,
                        value: settings.webpQuality is not null ? settings.webpQuality : '',
                        errors: settings.getErrors('webpQuality') ?? [],
                        size: 5
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable AVIF' | t('picture-tag'),
                        name: 'settings[enableAvif]',
                        on: settings.enableAvif ?? false
                    }) }}
                    {{ forms.textField({
                        label: 'AVIF Quality' | t('picture-tag'),
                        name: 'settings[avifQuality]',
                        placeholder: settings.PLACEHOLDER_AVIF_QUALITY,
                        value: settings.avifQuality is not null ? settings.avifQuality : '',
                        errors: settings.getErrors('avifQuality') ?? [],
                        size: 5
                    }) }}
                    <h2>{{ 'SVG Handling' | t('picture-tag') }}</h2>
                    {{ forms.lightswitchField({
                        label: 'Enable SVG Optimization' | t('picture-tag'),
                        name: 'settings[enableSvgOptimization]',
                        on: settings.enableSvgOptimization ?? false
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Inline SVG' | t('picture-tag'),
                        name: 'settings[inlineSvg]',
                        on: settings.inlineSvg ?? false
                    }) }}
                    {{ forms.textField({
                        label: 'SVG Max Size (bytes)' | t('picture-tag'),
                        name: 'settings[svgMaxSize]',
                        placeholder: settings.PLACEHOLDER_SVG_MAX_SIZE,
                        value: settings.svgMaxSize is not null ? settings.svgMaxSize : '',
                        errors: settings.getErrors('svgMaxSize') ?? [],
                        size: 5
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Require Alt Text' | t('picture-tag'),
                        name: 'settings[requireAltText]',
                        on: settings.requireAltText ?? true
                    }) }}
                    {{ forms.textField({
                        label: 'Default Alt Text' | t('picture-tag'),
                        name: 'settings[defaultAltText]',
                        placeholder: settings.PLACEHOLDER_DEFAULT_ALT_TEXT,
                        value: settings.defaultAltText is not null ? settings.defaultAltText : '',
                        errors: settings.getErrors('defaultAltText') ?? []
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Cache' | t('picture-tag'),
                        name: 'settings[enableCache]',
                        on: settings.enableCache ?? true
                    }) }}
                    {{ forms.textField({
                        label: 'Cache Duration (seconds)' | t('picture-tag'),
                        name: 'settings[cacheDuration]',
                        placeholder: settings.PLACEHOLDER_CACHE_DURATION,
                        value: settings.cacheDuration is not null ? settings.cacheDuration : '',
                        errors: settings.getErrors('cacheDuration') ?? [],
                        size: 5,
                        instructions: 'Duration in seconds' | t('picture-tag')
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Debug' | t('picture-tag'),
                        name: 'settings[enableDebug]',
                        on: settings.enableDebug ?? false
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Show Transform Info' | t('picture-tag'),
                        name: 'settings[showTransformInfo]',
                        on: settings.showTransformInfo ?? false
                    }) }}
                </div>

                {# Breakpoints Tab #}
                <div id="breakpoints" class="tab-content {% if selectedTab != 'breakpoints' %}hidden{% endif %}" data-tab-content="breakpoints">
                    {% for key, value in settings.PLACEHOLDER_DEFAULT_BREAKPOINTS %}
                        {{ forms.textField({
                            label: key | capitalize | t('picture-tag'),
                            name: 'settings[defaultBreakpoints][' ~ key | e('html') ~ ']',
                            placeholder: settings.PLACEHOLDER_DEFAULT_BREAKPOINTS[key],
                            value: settings.getDefaultBreakpoints()[key] is not null ? settings.getDefaultBreakpoints()[key] : '',
                            errors: settings.getErrors('defaultBreakpoints.' ~ key) ?? [],
                            required: true,
                            instructions: 'Pixel width for breakpoint' | t('picture-tag')
                        }) }}
                    {% endfor %}
                </div>

                {# Transforms Tab #}
                <div id="transforms" class="tab-content {% if selectedTab != 'transforms' %}hidden{% endif %}" data-tab-content="transforms">
                    {{ forms.lightswitchField({
                        label: 'Enable Default Transforms' | t('picture-tag'),
                        name: 'settings[enableDefaultTransforms]',
                        on: settings.enableDefaultTransforms ?? false
                    }) }}
                    {% if settings.enableDefaultTransforms %}
                        {% for key, transform in settings.PLACEHOLDER_DEFAULT_TRANSFORMS %}
                            <h3>{{ key | capitalize | t('picture-tag') }}</h3>
                            <div class="flex items-center gap-xl">
                                {{ forms.textField({
                                    label: 'Width' | t('picture-tag'),
                                    name: 'settings[defaultTransforms][' ~ key | e('html') ~ '][width]',
                                    placeholder: settings.PLACEHOLDER_DEFAULT_TRANSFORMS[key].width,
                                    value: settings.defaultTransforms[key].width is defined ? settings.defaultTransforms[key].width : '',
                                    errors: settings.getErrors('defaultTransforms.' ~ key ~ '.width') ?? [],
                                    required: true,
                                    instructions: 'In pixels' | t('picture-tag')
                                }) }}
                                {{ forms.textField({
                                    label: 'Height' | t('picture-tag'),
                                    name: 'settings[defaultTransforms][' ~ key | e('html') ~ '][height]',
                                    placeholder: settings.PLACEHOLDER_DEFAULT_TRANSFORMS[key].height,
                                    value: settings.defaultTransforms[key].height is defined ? settings.defaultTransforms[key].height : '',
                                    errors: settings.getErrors('defaultTransforms.' ~ key ~ '.height') ?? [],
                                    required: true,
                                    instructions: 'In pixels' | t('picture-tag')
                                }) }}
                                {{ forms.textField({
                                    label: 'Quality' | t('picture-tag'),
                                    name: 'settings[defaultTransforms][' ~ key | e('html') ~ '][quality]',
                                    placeholder: settings.PLACEHOLDER_DEFAULT_TRANSFORMS[key].quality,
                                    value: settings.defaultTransforms[key].quality is defined ? settings.defaultTransforms[key].quality : '',
                                    errors: settings.getErrors('defaultTransforms.' ~ key ~ '.quality') ?? [],
                                    required: true,
                                    instructions: '0-100' | t('picture-tag')
                                }) }}
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>

                {# Performance Tab #}
                <div id="performance" class="tab-content {% if selectedTab != 'performance' %}hidden{% endif %}" data-tab-content="performance">
                    {{ forms.lightswitchField({
                        label: 'Enable Lazy Loading' | t('picture-tag'),
                        name: 'settings[enableLazyLoading]',
                        on: settings.enableLazyLoading ?? true
                    }) }}
                    {{ forms.textField({
                        label: 'Lazy Loading Class' | t('picture-tag'),
                        name: 'settings[lazyLoadingClass]',
                        placeholder: settings.PLACEHOLDER_LAZY_LOADING_CLASS,
                        value: settings.lazyLoadingClass is not null ? settings.lazyLoadingClass : '',
                        errors: settings.getErrors('lazyLoadingClass') ?? []
                    }) }}
                    {{ forms.textareaField({
                        label: 'Lazy Placeholder' | t('picture-tag'),
                        name: 'settings[lazyPlaceholder]',
                        placeholder: settings.PLACEHOLDER_LAZY_PLACEHOLDER,
                        value: settings.lazyPlaceholder is not null ? settings.lazyPlaceholder : '',
                        rows: 4
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Preload' | t('picture-tag'),
                        name: 'settings[enablePreload]',
                        on: settings.enablePreload ?? false
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Sizes' | t('picture-tag'),
                        name: 'settings[enableSizes]',
                        on: settings.enableSizes ?? true
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Srcset' | t('picture-tag'),
                        name: 'settings[enableSrcset]',
                        on: settings.enableSrcset ?? true
                    }) }}
                    {{ forms.lightswitchField({
                        label: 'Enable Fetch Priority' | t('picture-tag'),
                        name: 'settings[enableFetchPriority]',
                        on: settings.enableFetchPriority ?? true
                    }) }}
                </div>
            </div>
        </div>
    </form>
{% endblock %}